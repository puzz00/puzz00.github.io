<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./pts.css">
    <title>system and host attacks impersonating user access tokens</title>
</head>
<body>
    <header class="navbar">
        <a href="https://github.com/puzz00" target="_blank"><img src="./images/chess_1.jpg" alt="black or white?"></a>
        <h1>tokens</h1>
        <nav class="links">
            <ul>
                <li><a href="./index.html">home</a></li>
                <li><a href="./host_and_network_pen_testing.html">host and network</a></li>
                <li><a href="./system_and_host_attacks.html">system and host attacks</a></li>
                <li><a href="./win_pe.html">win priv esc</a></li>
                <li><a class="active" href="#">tokens</a></li>
            </ul>
        </nav>
    </header>
    <section class="gallery">
        <div class="card">
            <a href="https://diannaosec.blogspot.com/2023/10/hacking-alfred-thm.html" target="_blank"><img src="images/alfred.png" alt="a box with security tokens for priv esc"></a>
            <a href="https://diannaosec.blogspot.com/2023/10/hacking-alfred-thm.html" target="_blank">Hacking Alfred - thm - Windows</a>
        </div>
    </section>
    <section class="main-content">
        <h2>Access Tokens</h2>
        <p>
            Access tokens are created and managed by the Local Security Authority Subsystem Service. They are generated by the winlogon.exe process when users log into windows. These tokens are attached to the userinit.exe process and contain data relating to the identity and privileges of the user account. All child processes started by a user will inherit a copy of the access token and therefore have the same privileges as the user. These tokens therefore control what users can access and not access on windows. They are like session cookies.
        </p>
        <p>
            Access tokens have two types of security level - impersonate and delegate level tokens. The delegate tokens are more dangerous as they can be used to impersonate tokens on any system because they are generated as a result of an interactive login such as a normal log into windows or via rdp. Impersonate tokens are created as a result of non-interactive logins and can only be used to impersonate tokens on a local system.
        </p>
        <p>
            In order to impersonate access tokens as a means of gaining an elevated session, the user we have gained an initial shell as needs to have specific privileges. The most useful of these is the <code>SeImpersonatePrivilege</code> which allows a user to create a process under the security context of another user which will typically have admin privileges. The <code>SeAssignPrimaryToken</code> lets users impersonate access tokens and the <code>SeCreateToken</code> lets users create arbitary tokens which have administrative privileges.
        </p>
        <p>
            The access tokens which can be impersonated will depend on which tokens are available on the system. In order to find these, we can load the incognito module in a meterpreter session: <code>load incognito</code> We will see the Delegation and Impersonate tokens which are available. If none are available, we can try a potato attack to create one. This section does not cover potato attacks - we are focusing on impersonating the tokens which are already available.
        </p>
        <h2>Incognito Module</h2>
        <p>
            Once we have gained a meterpreter session, we can use: <code>load incognito</code> and then: <code>list_tokens -u</code> The -u flag is the user flag. If we see a user we would like to impersonate, we can use: <code>impersonate_token "ATTACKDEFENCE\Administrator"</code> We typically want to impersonate accounts which have higher privileges than our current session, but if there are other low-level user tokens available it can be useful to impersonate them for the purpose of horizontal movement across a system - we might find useful data or other priv esc opportunities when we have moved horizonally to a different user.
        </p>
        <p>
            Once we have impersonated an access token, it could be useful to use: <code>list_tokens -u</code> again to see if any further access tokens such as NT AUTHORITY\SYSTEM are available as we can impersonate these newly available tokens, too.
        </p>
    </section>
    <section class="extra-info">
        <p class="tagline">
            water shapes its course according to the nature of the ground over which it flows - the soldier works out his victory in relation to the foe whom he is facing
        </p>
        <div class="contact">
            <p>puzz00</p>
            <a href="https://github.com/puzz00" class="active" target="_blank">knock knock</a>
        </div>
    </section>
</body>
</html>